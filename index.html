<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lymo</title>
<link rel="manifest" href="assets/manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* --- Minimal styling for Lymo --- */
  :root{
    --bg:#071017; --card:#081018;
    --lime-1:#c7ff5a; --lime-2:#8ef23b;
    --muted:#9fb1b1;
    --radius:14px; --shadow: 0 12px 40px rgba(2,8,10,0.6);
    --accent: linear-gradient(90deg,var(--lime-1),var(--lime-2));
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto;
    color-scheme: dark;
  }
  body{margin:0;padding:28px; background:#071017; color:#e6f5e9; min-height:100vh;}
  header{display:flex;align-items:center;gap:16px;position:sticky;top:0;padding:10px 12px;background:rgba(255,255,255,0.02);border-radius:12px;}
  .logo{font-weight:800; background:var(--accent); color:#041b07; padding:10px 14px; border-radius:12px;}
  .search{margin-left:auto; display:flex;align-items:center;gap:8px; background:rgba(255,255,255,0.02);border-radius:999px; padding:8px;}
  .search input{background:transparent;border:0;outline:none;color:inherit;width:180px;font-weight:600;}
  main{display:grid;grid-template-columns:1fr 320px;gap:22px;margin-top:18px;}
  .feed{max-width:940px;}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--lime-1);cursor:pointer;font-weight:700;}
  .btn.primary{background:var(--accent);color:#05220b;border:none;}
  .composer{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;}
  textarea{flex:1;min-height:68px;resize:vertical;background:transparent;border:1px dashed rgba(255,255,255,0.03);padding:10px;border-radius:10px;color:inherit;}
  .post{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:12px;border-radius:14px;display:flex;gap:12px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px;align-items:flex-start;}
  .votes{display:flex;flex-direction:column;align-items:center;gap:8px;}
  .score{font-weight:800;color:var(--lime-1);}
  aside{position:sticky;top:86px;height:calc(100vh - 140px);overflow:auto;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
</style>
</head>
<body>

<header>
  <div class="logo">Lymo</div>
  <div class="search">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    <input id="searchInput" placeholder="Search posts...">
  </div>
</header>

<main>
  <section class="feed">
    <div class="controls">
      <button id="adminToggle" class="btn">Admin</button>
      <button id="newPostBtn" class="btn primary">New Post</button>
      <select id="sortSelect" class="btn" style="margin-left:auto;">
        <option value="hot">Hot</option>
        <option value="new">New</option>
        <option value="top">Top</option>
      </select>
    </div>

    <div id="composer" class="composer disabled">
      <textarea id="postBody" placeholder="Write something (admin only)..."></textarea>
      <div style="display:flex; flex-direction:column; gap:6px;">
        <input id="postTitle" placeholder="Title" style="padding:6px;border-radius:8px;">
        <input id="postImage" placeholder="Image URL (optional)" style="padding:6px;border-radius:8px;">
        <button id="submitPost" class="btn primary">Post</button>
      </div>
    </div>

    <div id="posts"></div>
  </section>

  <aside>
    <h4>Liked Posts <span id="likedCount">0</span></h4>
    <div id="likedList"></div>
    <h4>Admin Controls</h4>
    <button id="changePassBtn" class="btn">Change Admin Password</button>
    <button id="logoutBtn" class="btn">Logout Admin</button>
  </aside>
</main>

<script>
/* ----------------- Appwrite Secrets ----------------- */
const client = new Appwrite.Client()
    .setEndpoint("https://nyc.cloud.appwrite.io/v1")
    .setProject("6930516e001b85af6b1e");

const account = new Appwrite.Account(client);
const storage = new Appwrite.Storage(client);

async function loadSecrets() {
    await account.createAnonymousSession();
    const fileBlob = await storage.getFileView("69305285002f8b73e74a","69305332002860f9ba24");
    const secrets = JSON.parse(await fileBlob.text());
    window.API_KEY = secrets.apikey;
    window.ADMIN_POST_BIN_ID = secrets.binid;
    startLymo();
}

/* ----------------- App State ----------------- */
let posts = [];
let adminPassword = '';
let liked = new Set(JSON.parse(localStorage.getItem('lymo_liked_v1')||'[]'));
let adminLogged = false;

/* ----------------- Utility ----------------- */
function uid(){return 'p_'+Math.random().toString(36).slice(2,10);}
function saveLiked(){localStorage.setItem('lymo_liked_v1', JSON.stringify(Array.from(liked)));}

/* ----------------- JSONBin ----------------- */
async function loadPosts(){
    const res = await fetch(`https://api.jsonbin.io/v3/b/${ADMIN_POST_BIN_ID}/latest`, {
        headers: {"X-Master-Key": API_KEY}
    });
    const data = await res.json();
    posts = data?.record?.posts || [];
    adminPassword = data?.record?.adminPassword || '';
    renderPosts();
    renderLiked();
}

async function savePosts(){
    await fetch(`https://api.jsonbin.io/v3/b/${ADMIN_POST_BIN_ID}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json","X-Master-Key":API_KEY},
        body: JSON.stringify({posts, adminPassword})
    });
}

/* ----------------- Render ----------------- */
const postsEl = document.getElementById('posts');
const likedListEl = document.getElementById('likedList');
const likedCountEl = document.getElementById('likedCount');

function renderPosts(filter=''){
    postsEl.innerHTML = '';
    const sort = document.getElementById('sortSelect').value;
    let list = [...posts];
    if(sort==='new') list.sort((a,b)=>b.created-a.created);
    else if(sort==='top') list.sort((a,b)=>b.score-a.score);
    else list.sort((a,b)=> (b.score + (Date.now()-b.created)/10000000) - (a.score + (Date.now()-a.created)/10000000));
    if(filter) list = list.filter(p => (p.title+' '+p.body).toLowerCase().includes(filter.toLowerCase()));

    list.forEach(p=>{
        const node = document.createElement('div');
        node.className='post';
        node.innerHTML = `<div class="votes">
            <button class="up">▲</button>
            <div class="score">${p.score}</div>
            <button class="down">▼</button>
        </div>
        <div>
            <strong>${p.title}</strong><br>${p.body || ''}
        </div>`;
        const up=node.querySelector('.up');
        const down=node.querySelector('.down');
        const scoreEl=node.querySelector('.score');
        up.onclick=()=>{p.score++; scoreEl.textContent=p.score; savePosts(); renderLiked();}
        down.onclick=()=>{p.score--; scoreEl.textContent=p.score; savePosts(); renderLiked();}
        postsEl.appendChild(node);
    });
}

function renderLiked(){
    likedListEl.innerHTML=''; likedCountEl.textContent=liked.size;
    Array.from(liked).forEach(id=>{
        const p=posts.find(x=>x.id===id);
        if(!p) return;
        const el=document.createElement('div');
        el.textContent=p.title+' ('+p.score+')';
        likedListEl.appendChild(el);
    });
}

/* ----------------- Admin ----------------- */
const composerEl=document.getElementById('composer');
const submitBtn=document.getElementById('submitPost');
const postTitle=document.getElementById('postTitle');
const postBody=document.getElementById('postBody');
const postImage=document.getElementById('postImage');
const adminToggle=document.getElementById('adminToggle');
const changePassBtn=document.getElementById('changePassBtn');
const logoutBtn=document.getElementById('logoutBtn');

function updateAdminUI(){composerEl.classList.toggle('disabled',!adminLogged);}

function requireAdmin(){
    if(!adminPassword){
        const p=prompt('Set new admin password:'); if(!p) return false; adminPassword=p; savePosts(); alert('Password set'); return false;
    }
    const pass=prompt('Enter admin password:'); if(pass===adminPassword){adminLogged=true;updateAdminUI();alert('Logged in!'); return true;}
    alert('Wrong password'); return false;
}

adminToggle.onclick=()=>{if(adminLogged){if(confirm('Logout?')){adminLogged=false;updateAdminUI();}}else{requireAdmin();}};
submitBtn.onclick=async ()=>{
    if(!adminLogged){alert('Only admins can post');return;}
    const newPost={id:uid(),title:postTitle.value||'(no title)',body:postBody.value,score:0,created:Date.now(),img:postImage.value};
    posts.unshift(newPost);
    await savePosts();
    postTitle.value=''; postBody.value=''; postImage.value='';
    renderPosts();
};
changePassBtn.onclick=()=>{if(!adminLogged){alert('Login first');return;}const p=prompt('New password:');if(!p)return;adminPassword=p;savePosts();alert('Saved');};
logoutBtn.onclick=()=>{adminLogged=false;updateAdminUI();};

/* ----------------- Search / Sort ----------------- */
document.getElementById('searchInput').addEventListener('input',e=>renderPosts(e.target.value));
document.getElementById('sortSelect').addEventListener('change',()=>renderPosts(document.getElementById('searchInput').value));

/* ----------------- Startup ----------------- */
function startLymo(){loadPosts();}
loadSecrets();
</script>

</body>
</html>
